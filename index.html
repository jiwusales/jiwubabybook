<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>吉物販售 吉伊卡哇寶寶圖鑑</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f8f8f8;
  }
  h1 {
    text-align: center;
    color: #333;
  }
  #sheetButtons {
    text-align: center;
    margin-bottom: 30px;
  }
  #sheetButtons button {
    background-color: #eee;
    border: none;
    border-radius: 15px;
    padding: 8px 15px;
    margin: 0 6px 10px 6px;
    font-size: 1em;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  #sheetButtons button.active {
    background-color: #FF69B4;
    color: white;
  }
  #sheetButtons button:hover:not(.active) {
    background-color: #ddd;
  }
  .group {
    margin-bottom: 40px;
  }
  .group-title {
    text-align: center;
    font-size: 1.4em;
    margin-bottom: 15px;
    color: #555;
  }
  .cards {
    display: flex;
    flex-wrap: nowrap;
    gap: 10px;
    overflow-x: auto;
  }
  .card {
    background: white;
    border: 2px solid transparent;
    border-radius: 8px;
    width: 18%;
    min-width: 150px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: border-color 0.3s, box-shadow 0.3s;
    position: relative;
    text-align: center;
  }
  .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .card.selected {
    border-color: #FF69B4;
  }
  .card img {
    width: 100%;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
  }
  .info {
    padding: 8px;
    font-size: 0.9em;
    color: #333;
  }
  .checkmark {
    position: absolute;
    top: 6px;
    right: 6px;
    background: #FF69B4;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: none;
    justify-content: center;
    align-items: center;
    font-size: 14px;
  }
  .card.selected .checkmark {
    display: flex;
  }
</style>
</head>
<body>
  <h1>娃娃圖鑑</h1>
  <div id="sheetButtons" role="tablist" aria-label="角色分頁切換"></div>

  <div id="catalog"></div>

  <script>
    const sheetID = "17gH9HZKvW_6fMCWYLyqnzMHj40rA7PiwWg6L0GvbFgQ";

    const sheetNames = ["吉伊", "小八", "兔兔", "小桃", "師傅", "栗子", "獅薩", "古本", "其他角色"];
    const sheetButtons = document.getElementById("sheetButtons");
    const catalog = document.getElementById("catalog");

    let currentSheet = sheetNames[0];

    function createButtons() {
      sheetNames.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.type = "button";
        btn.setAttribute("role", "tab");
        btn.setAttribute("aria-selected", "false");
        btn.addEventListener("click", () => {
          if(currentSheet === name) return;
          currentSheet = name;
          updateActiveButton();
          loadSheet(name);
        });
        sheetButtons.appendChild(btn);
      });
    }

    function updateActiveButton() {
      Array.from(sheetButtons.children).forEach(btn => {
        if (btn.textContent === currentSheet) {
          btn.classList.add("active");
          btn.setAttribute("aria-selected", "true");
          btn.focus();
        } else {
          btn.classList.remove("active");
          btn.setAttribute("aria-selected", "false");
        }
      });
    }

    // 解析Google Sheets返回的JSONP格式，取出JSON物件
    function parseJSONP(text) {
      const jsonStr = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
      return JSON.parse(jsonStr);
    }

    function fetchSheetData(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&range=A:D`;
      return fetch(url)
        .then(res => res.text())
        .then(text => {
          const json = parseJSONP(text);
          const rows = json.table.rows || [];
          return rows.map(r => ({
            type: r.c[0]?.v || "",
            name: r.c[1]?.v || "",
            img: r.c[2]?.v || "",
            size: r.c[3]?.v || ""
          }));
        });
    }

    function renderCatalog(entries, sheetName) {
      catalog.innerHTML = "";
      if (entries.length === 0) {
        catalog.innerHTML = `<p style="text-align:center;color:#888;">${sheetName} 分頁沒有資料喔</p>`;
        return;
      }

      const grouped = {};
      entries.forEach(item => {
        if (!grouped[item.type]) grouped[item.type] = [];
        grouped[item.type].push(item);
      });

      Object.keys(grouped).forEach(type => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "group";

        const title = document.createElement("div");
        title.className = "group-title";
        title.textContent = `－－－ ${type} －－－`;
        groupDiv.appendChild(title);

        const cardsContainer = document.createElement("div");
        cardsContainer.className = "cards";

        grouped[type].forEach(item => {
          const card = document.createElement("div");
          card.className = "card";

          const id = `${sheetName}|${type}|${item.name}`;
          if (localStorage.getItem(id)) card.classList.add("selected");

          const img = document.createElement("img");
          img.src = item.img;
          img.alt = item.name;

          const info = document.createElement("div");
          info.className = "info";
          info.innerHTML = `<div>${item.name}</div><div>${item.size}</div>`;

          const checkmark = document.createElement("div");
          checkmark.className = "checkmark";
          checkmark.textContent = "✔";

          card.appendChild(img);
          card.appendChild(info);
          card.appendChild(checkmark);

          card.addEventListener("click", () => {
            card.classList.toggle("selected");
            if (card.classList.contains("selected")) {
              localStorage.setItem(id, "1");
            } else {
              localStorage.removeItem(id);
            }
          });

          cardsContainer.appendChild(card);
        });

        groupDiv.appendChild(cardsContainer);
        catalog.appendChild(groupDiv);
      });
    }

    function loadSheet(sheetName) {
      catalog.innerHTML = "<p style='text-align:center;color:#888;'>資料載入中...</p>";
      fetchSheetData(sheetName)
        .then(entries => renderCatalog(entries, sheetName))
        .catch(() => {
          catalog.innerHTML = "<p style='text-align:center;color:red;'>載入資料失敗，請稍後再試。</p>";
        });
    }

    createButtons();
    updateActiveButton();
    loadSheet(currentSheet);
  </script>
</body>
</html>
